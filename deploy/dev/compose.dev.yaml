# Ruby Core Development Environment
# Phase 1: Secure Infrastructure
#
# ADR-0021: Single-node NATS with JetStream persistence
# ADR-0018: TLS everywhere (mTLS for NATS)
# ADR-0017: NKEY-based authentication
# ADR-0015: Vault for secrets (general-purpose Vault on node)

services:
  # ==========================================================================
  # NATS Certificate Init (fetches server certs from Vault into tmpfs)
  # ==========================================================================
  nats-init:
    image: hashicorp/vault:1.15
    container_name: ruby-core-dev-nats-init
    restart: "no"
    entrypoint: ["/bin/sh"]
    command: ["/scripts/fetch-nats-certs.sh"]
    volumes:
      - nats-certs:/certs
      - ../../scripts/fetch-nats-certs.sh:/scripts/fetch-nats-certs.sh:ro
    environment:
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN:-root}
    networks:
      - vault

  # ==========================================================================
  # NATS JetStream Message Broker
  # ==========================================================================
  nats:
    image: nats:2.10-alpine
    container_name: ruby-core-dev-nats
    restart: unless-stopped
    depends_on:
      nats-init:
        condition: service_completed_successfully
    ports:
      # Client port (TLS)
      - "4222:4222"
      # HTTP monitoring
      - "8222:8222"
    volumes:
      # JetStream persistent storage (ADR-0021)
      - ruby-core-dev-nats-data:/data/jetstream
      # NATS configuration
      - ../base/nats/nats.conf:/etc/nats/nats.conf:ro
      # Generated authorization config (from scripts/setup-credentials.sh)
      - ../base/nats/auth.conf:/etc/nats/auth.conf:ro
      # TLS certificates (fetched from Vault by nats-init into tmpfs)
      - nats-certs:/etc/nats/certs:ro
    command: ["-c", "/etc/nats/nats.conf"]
    healthcheck:
      # Health check via HTTP monitoring endpoint
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ==========================================================================
  # Gateway Service (profile: services)
  # ==========================================================================
  # Activated with: docker compose --profile services up -d
  # ADR-0015: All secrets from Vault (no cert volume mounts)
  # ADR-0018: mTLS via Vault-sourced client certificates
  gateway:
    profiles: [services]
    build:
      context: ../..
      dockerfile: services/gateway/Dockerfile
    container_name: ruby-core-dev-gateway
    restart: unless-stopped
    networks:
      - default
      - vault
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN:-root}
      - NATS_URL=tls://nats:4222
      - NATS_REQUIRE_MTLS=true
      - VAULT_NKEY_PATH=secret/data/ruby-core/nats/gateway
      - VAULT_TLS_PATH=secret/data/ruby-core/tls/gateway

  # ==========================================================================
  # Engine Service (profile: services)
  # ==========================================================================
  engine:
    profiles: [services]
    build:
      context: ../..
      dockerfile: services/engine/Dockerfile
    container_name: ruby-core-dev-engine
    restart: unless-stopped
    networks:
      - default
      - vault
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN:-root}
      - NATS_URL=tls://nats:4222
      - NATS_REQUIRE_MTLS=true
      - VAULT_NKEY_PATH=secret/data/ruby-core/nats/engine
      - VAULT_TLS_PATH=secret/data/ruby-core/tls/engine

# ==========================================================================
# Networks
# ==========================================================================
networks:
  default:
  vault:
    external: true
    name: vault_default

# ==========================================================================
# Named Volumes
# ==========================================================================
volumes:
  # Persistent JetStream storage (dev only)
  # NOTE: For production, ADR-0021 requires a host bind mount to a reliable
  # path that is included in automated backups. Example for prod:
  #   volumes:
  #     - /var/lib/ruby-core/nats:/data/jetstream
  # See deploy/prod/compose.prod.yaml for production configuration.
  ruby-core-dev-nats-data:
    driver: local
  # TLS certificates fetched from Vault by nats-init at startup.
  # Certs live here instead of in the repo tree (deploy/base/nats/certs/).
  # Cleaned up with: docker compose down -v
  nats-certs:
    driver: local
