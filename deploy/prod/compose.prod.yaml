# Ruby Core Production Environment
# Phase 2: Minimal gateway + engine with NATS
#
# ADR-0021: Single-node NATS with host bind mount for backups
# ADR-0018: TLS everywhere
# ADR-0017: NKEY-based authentication
# ADR-0015: Secrets from Vault (general-purpose Vault on node)

services:
  # ==========================================================================
  # NATS Certificate Init (fetches server certs from Vault into tmpfs)
  # ==========================================================================
  nats-init:
    image: hashicorp/vault:1.15
    container_name: ruby-core-prod-nats-init
    restart: "no"
    entrypoint: ["/bin/sh"]
    command: ["/scripts/fetch-nats-certs.sh"]
    volumes:
      - nats-certs:/certs
      - ../../scripts/fetch-nats-certs.sh:/scripts/fetch-nats-certs.sh:ro
    environment:
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN}
    networks:
      - vault

  # ==========================================================================
  # NATS JetStream Message Broker (Production)
  # ==========================================================================
  nats:
    image: nats:2.10-alpine
    container_name: ruby-core-prod-nats
    restart: unless-stopped
    depends_on:
      nats-init:
        condition: service_completed_successfully
    ports:
      # Client port (TLS only) - offset from dev (4222) to allow coexistence
      - "127.0.0.1:4223:4222"
      # HTTP monitoring - localhost only, offset from dev (8222)
      - "127.0.0.1:8223:8222"
    volumes:
      # JetStream persistent storage - HOST BIND MOUNT (ADR-0021)
      # This path MUST be included in automated backups
      - /var/lib/ruby-core/nats:/data/jetstream
      # NATS configuration
      - ../base/nats/nats.conf:/etc/nats/nats.conf:ro
      # Generated authorization config (from scripts/setup-credentials.sh)
      - ../base/nats/auth.conf:/etc/nats/auth.conf:ro
      # TLS certificates (fetched from Vault by nats-init into tmpfs)
      - nats-certs:/etc/nats/certs:ro
    command: ["-c", "/etc/nats/nats.conf"]
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # NOTE: Gateway and Engine require Vault connectivity at startup to fetch
  # NKEY seeds and TLS certificates. The general-purpose Vault on this node
  # must be running before starting services.

  # ==========================================================================
  # Gateway Service
  # ==========================================================================
  gateway:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/ruby-core-gateway:${VERSION:-v0.1.0}
    container_name: ruby-core-prod-gateway
    restart: unless-stopped
    networks:
      - default
      - vault
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - ENVIRONMENT=production
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_ALLOW_HTTP=true
      - NATS_URL=${NATS_URL:-tls://nats:4222}
      - NATS_REQUIRE_MTLS=true
      - VAULT_NKEY_PATH=${VAULT_NKEY_PATH_GATEWAY:-secret/data/ruby-core/nats/gateway}
      - VAULT_TLS_PATH=${VAULT_TLS_PATH_GATEWAY:-secret/data/ruby-core/tls/gateway}

  # ==========================================================================
  # Engine Service
  # ==========================================================================
  engine:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/ruby-core-engine:${VERSION:-v0.1.0}
    container_name: ruby-core-prod-engine
    restart: unless-stopped
    networks:
      - default
      - vault
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - ENVIRONMENT=production
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_ALLOW_HTTP=true
      - NATS_URL=${NATS_URL:-tls://nats:4222}
      - NATS_REQUIRE_MTLS=true
      - VAULT_NKEY_PATH=${VAULT_NKEY_PATH_ENGINE:-secret/data/ruby-core/nats/engine}
      - VAULT_TLS_PATH=${VAULT_TLS_PATH_ENGINE:-secret/data/ruby-core/tls/engine}

# ==========================================================================
# Networks
# ==========================================================================
networks:
  default:
  vault:
    external: true
    name: vault_default

# ==========================================================================
# Volumes
# ==========================================================================
# JetStream uses a host bind mount (not a named volume) for reliable backups.
# The nats-certs volume is RAM-backed (tmpfs) â€” certs are fetched from Vault
# at startup and never written to disk.
volumes:
  nats-certs:
    driver: local
