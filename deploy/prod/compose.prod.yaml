# Ruby Core Production Environment
# Phase 2: Minimal gateway + engine with NATS
#
# ADR-0021: Single-node NATS with host bind mount for backups
# ADR-0018: TLS everywhere
# ADR-0017: NKEY-based authentication
# ADR-0015: Secrets from Vault

services:
  # ==========================================================================
  # NATS JetStream Message Broker (Production)
  # ==========================================================================
  nats:
    image: nats:2.10-alpine
    container_name: ruby-core-nats
    restart: unless-stopped
    ports:
      # Client port (TLS only) - localhost since services are co-located
      - "127.0.0.1:4222:4222"
      # HTTP monitoring - bind to localhost only in production
      - "127.0.0.1:8222:8222"
    volumes:
      # JetStream persistent storage - HOST BIND MOUNT (ADR-0021)
      # This path MUST be included in automated backups
      - /var/lib/ruby-core/nats:/data/jetstream
      # NATS configuration
      - ../base/nats/nats.conf:/etc/nats/nats.conf:ro
      # TLS certificates (from Vault PKI in production)
      - ../base/nats/certs:/etc/nats/certs:ro
    command: ["-c", "/etc/nats/nats.conf"]
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # Gateway Service
  # ==========================================================================
  gateway:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/ruby-core-gateway:${VERSION:-v0.1.0}
    container_name: ruby-core-gateway
    restart: unless-stopped
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - NATS_URL=${NATS_URL:-tls://nats:4222}
      - NATS_REQUIRE_MTLS=true
      - VAULT_NKEY_PATH=${VAULT_NKEY_PATH_GATEWAY:-secret/data/ruby-core/nats/gateway}
      - VAULT_TLS_PATH=${VAULT_TLS_PATH_GATEWAY:-secret/data/ruby-core/tls/gateway}

  # ==========================================================================
  # Engine Service
  # ==========================================================================
  engine:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/ruby-core-engine:${VERSION:-v0.1.0}
    container_name: ruby-core-engine
    restart: unless-stopped
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - NATS_URL=${NATS_URL:-tls://nats:4222}
      - NATS_REQUIRE_MTLS=true
      - VAULT_NKEY_PATH=${VAULT_NKEY_PATH_ENGINE:-secret/data/ruby-core/nats/engine}
      - VAULT_TLS_PATH=${VAULT_TLS_PATH_ENGINE:-secret/data/ruby-core/tls/engine}

# ==========================================================================
# No named volumes in production - use host bind mounts for reliable backups
# ==========================================================================
