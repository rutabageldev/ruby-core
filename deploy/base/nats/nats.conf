# NATS Server Configuration for Ruby Core
# ADR-0017: NKEY-based authentication with per-service ACLs
# ADR-0018: TLS everywhere (mTLS for client connections)
# ADR-0021: Single-node resilient deployment with JetStream persistence

# Server identification
server_name: ruby-core-nats

# Client port
port: 4222

# HTTP monitoring port (bound to localhost via compose port mapping in production)
http_port: 8222

# =============================================================================
# JetStream Configuration (ADR-0021)
# =============================================================================
jetstream {
  # Storage directory - must be mounted to a persistent host volume
  store_dir: /data/jetstream

  # Resource limits (adjust based on host capacity)
  max_memory_store: 256MB
  max_file_store: 1GB
}

# =============================================================================
# TLS Configuration (ADR-0018)
# =============================================================================
# mTLS: Both server and client must present valid certificates
tls {
  cert_file: /etc/nats/certs/server-cert.pem
  key_file: /etc/nats/certs/server-key.pem
  ca_file: /etc/nats/certs/ca.pem

  # Require client certificates (mTLS)
  # Note: Use 'verify: true' for mTLS with NKEY auth.
  # 'verify_and_map' is for mapping TLS certs to users, which conflicts with NKEY auth.
  verify: true

  # Minimum TLS version - explicitly require TLS 1.3
  min_version: "1.3"

  # TLS handshake timeout in seconds
  timeout: 2
}

# =============================================================================
# Authorization Configuration (ADR-0017)
# =============================================================================
# NKEY-based authentication with per-service ACLs
# Generated by scripts/setup-credentials.sh â€” do not edit nats.conf for auth.
# To regenerate: make setup-creds-force
include ./auth.conf

# =============================================================================
# Logging Configuration
# =============================================================================
debug: false
trace: false
logtime: true

# =============================================================================
# Connection Limits
# =============================================================================
max_connections: 100
max_payload: 1MB
