# NATS Server Configuration for Ruby Core
# ADR-0017: NKEY-based authentication with per-service ACLs
# ADR-0018: TLS everywhere (mTLS for client connections)
# ADR-0021: Single-node resilient deployment with JetStream persistence

# Server identification
server_name: ruby-core-nats

# Client port
port: 4222

# HTTP monitoring port (localhost only in production)
http_port: 8222

# =============================================================================
# JetStream Configuration (ADR-0021)
# =============================================================================
jetstream {
  # Storage directory - must be mounted to a persistent host volume
  store_dir: /data/jetstream

  # Resource limits (adjust based on host capacity)
  max_memory_store: 256MB
  max_file_store: 1GB
}

# =============================================================================
# TLS Configuration (ADR-0018)
# =============================================================================
# mTLS: Both server and client must present valid certificates
tls {
  cert_file: /etc/nats/certs/server-cert.pem
  key_file: /etc/nats/certs/server-key.pem
  ca_file: /etc/nats/certs/ca.pem

  # Require client certificates (mTLS)
  # Note: Use 'verify: true' for mTLS with NKEY auth.
  # 'verify_and_map' is for mapping TLS certs to users, which conflicts with NKEY auth.
  verify: true

  # Minimum TLS version - explicitly require TLS 1.2+
  min_version: "1.2"

  # TLS handshake timeout in seconds
  timeout: 2
}

# =============================================================================
# Authorization Configuration (ADR-0017)
# =============================================================================
# NKEY-based authentication with per-service ACLs
# Each service has a unique NKEY and least-privilege permissions

authorization {
  # Default permissions - deny all (defense in depth)
  default_permissions: {
    publish: {
      deny: ">"
    }
    subscribe: {
      deny: ">"
    }
  }

  # Service accounts
  # NOTE: Replace placeholder NKEYs with real keys generated via:
  #   nk -gen user -pubout
  # Store seed keys in Vault (ADR-0015)
  #
  # Subject naming follows ADR-0027: {source}.{class}.{type}[.{id}][.{action}]
  # Classes: events, commands, audit, metrics, logs
  users: [
    # Gateway service
    # Responsibilities: Ingest events from Home Assistant, execute commands, publish audit
    {
      # Placeholder NKEY - replace with real public key
      nkey: "PLACEHOLDER_GATEWAY_NKEY"
      permissions: {
        publish: {
          allow: [
            # Events ingested from Home Assistant (source=ha, class=events)
            "ha.events.>",
            # Audit trail for command execution (source=ruby_gateway, class=audit)
            "ruby_gateway.audit.>",
            # Health/metrics for this service
            "ruby_gateway.metrics.>"
          ]
        }
        subscribe: {
          allow: [
            # Commands from engine to execute (source=ruby_engine, class=commands)
            "ruby_engine.commands.>"
          ]
        }
      }
    },

    # Engine service
    # Responsibilities: Process events, evaluate rules, publish commands
    {
      # Placeholder NKEY - replace with real public key
      nkey: "PLACEHOLDER_ENGINE_NKEY"
      permissions: {
        publish: {
          allow: [
            # Commands for gateway to execute
            "ruby_engine.commands.>",
            # Audit trail for rule evaluations
            "ruby_engine.audit.>",
            # Health/metrics for this service
            "ruby_engine.metrics.>"
          ]
        }
        subscribe: {
          allow: [
            # Events from Home Assistant to process
            "ha.events.>"
          ]
        }
      }
    },

    # Notifier service
    # Responsibilities: Send notifications based on commands
    {
      nkey: "PLACEHOLDER_NOTIFIER_NKEY"
      permissions: {
        publish: {
          allow: [
            # Audit trail for notifications sent
            "ruby_notifier.audit.>",
            # Health/metrics for this service
            "ruby_notifier.metrics.>"
          ]
        }
        subscribe: {
          allow: [
            # Notification commands from engine
            "ruby_engine.commands.notification.>"
          ]
        }
      }
    },

    # Presence service
    # Responsibilities: Track presence based on network events
    {
      nkey: "PLACEHOLDER_PRESENCE_NKEY"
      permissions: {
        publish: {
          allow: [
            # Presence events derived from network data
            "ruby_presence.events.>",
            # Audit trail
            "ruby_presence.audit.>",
            # Health/metrics for this service
            "ruby_presence.metrics.>"
          ]
        }
        subscribe: {
          allow: [
            # Network events from UniFi adapter
            "unifi.events.>"
          ]
        }
      }
    },

    # Admin/operator account (for debugging and maintenance)
    {
      nkey: "PLACEHOLDER_ADMIN_NKEY"
      permissions: {
        publish: {
          allow: ">"
        }
        subscribe: {
          allow: ">"
        }
      }
    }
  ]
}

# =============================================================================
# Logging Configuration
# =============================================================================
debug: false
trace: false
logtime: true

# =============================================================================
# Connection Limits
# =============================================================================
max_connections: 100
max_payload: 1MB
